<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ki·ªÉm Tra T·ªëc ƒê·ªô ƒê√°nh M√°y - Test ƒê√°nh M√°y KJC</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #B3E5FC, #F8BBD0);
            min-height: 100vh;
            color: #333;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            padding-top: 120px;
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 1;
        }

       /* Header Styles */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed; /* <-- thay absolute b·∫±ng fixed */
            top: 20px;
            left: 200px;
            right: 200px;
            padding: 10px 30px;
            z-index: 2;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            width: 100px;
            height: 50px;
            object-fit: contain;
            display: block;
        }

        .logo-text {
            font-size: 24px;
            font-weight: 600;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        nav ul {
            display: flex;
            list-style: none;
        }

        nav li {
            margin-left: 20px;
        }

        nav a {
            text-decoration: none;
            color: #fff;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 20px;
            transition: all 0.3s ease;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        nav a:hover {
            background-color: rgba(255,255,255,0.2);
        }

        nav a.active {
            background-color: rgba(255,255,255,0.3);
        }


        /* Typing Test Styles */
        .typing-container {
            background-color: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            max-width: 900px;
            margin-top: 30px;
            width: 95%;
            position: relative;
            width: 100%;
        }

        .typing-area {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .text-display {
            background-color: rgba(255,255,255,0.7);
            border-radius: 12px;
            padding: 30px;
            border: 1px solid rgba(0,0,0,0.1);
            font-size: 22px;
            line-height: 1.8;
            height: 140px;
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            align-items: flex-start;
            overflow: hidden;
            position: relative;
            transition: none;
        }

        .word {
            padding: 3px 5px;
            border-radius: 4px;
            white-space: nowrap;
            margin: 1px;
            position: relative;
            transition: all 0.2s ease;
        }
        
        .word.current {
            background-color: #4A90E2;
            color: white;
            box-shadow: 0 2px 4px rgba(74,144,226,0.3);
        }

        .word.correct {
            color: #4CAF50;
            background-color: rgba(76, 175, 80, 0.1);
        }

        .word.incorrect {
            color: #F44336;
            background-color: rgba(244, 67, 54, 0.1);
        }

        .word.current {
            background-color: #4A90E2;
            color: white;
            box-shadow: 0 2px 4px rgba(74,144,226,0.3);
        }

        .word.correct {
            color: #4CAF50;
        }

        .word.incorrect {
            color: #F44336;
            background-color: #ffebee;
        }

        .line-break {
            width: 100%;
            height: 0;
        }

        .input-area {
            background-color: rgba(255,255,255,0.7);
            border-radius: 12px;
            padding: 12px;
            border: 1px solid rgba(0,0,0,0.1);
            margin-top: 10px;
        }

        /* Row that contains the input and the retry button */
        .input-row {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .typing-input {
            flex: 1;
            padding: 12px 14px;
            font-size: 18px;
            border: 1px solid rgba(0,0,0,0.2);
            border-radius: 8px;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }

        /* Inline variant for side-btn used inside the input row */
        .side-btn.inline {
            padding: 10px 16px;
            white-space: nowrap;
        }

        .typing-input:focus {
            outline: none;
            border-color: #4A90E2;
            box-shadow: 0 0 0 2px rgba(74,144,226,0.2);
        }

        /* Real-time Stats */
        .real-time-stats {
            display: flex;
            justify-content: space-around;
            background: rgba(255,255,255,0.8);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .stat-item {
            text-align: center;
            flex: 1;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: #4A90E2;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Time Progress Bar */
        .time-progress-container {
            margin: 25px 0;
        }

        .time-progress-bar {
            height: 16px;
            background: #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .time-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            width: 100%;
            transition: width 1s linear;
            border-radius: 8px;
        }

        .time-progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 16px;
            color: #666;
            margin-top: 10px;
            font-weight: 500;
        }

        .time-remaining {
            color: #1a237e;
            font-weight: 600;
            font-size: 18px;
        }

        /* Side Buttons */
        .side-buttons {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 25px;
        }

        .side-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background-color: rgba(255,255,255,0.9);
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-decoration: none;
            color: #333;
        }

        .side-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        /* Enhanced Result Popup */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes glow {
            0% { box-shadow: 0 0 5px rgba(26, 35, 126, 0.3); }
            50% { box-shadow: 0 0 20px rgba(26, 35, 126, 0.5); }
            100% { box-shadow: 0 0 5px rgba(26, 35, 126, 0.3); }
        }

        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .result-popup {
            background: white;
            border-radius: 24px;
            padding: 0;
            max-width: 600px;
            width: 95%;
            box-shadow: 0 25px 60px rgba(0,0,0,0.25), 0 10px 20px rgba(0,0,0,0.15);
            max-height: 85vh;
            overflow: auto;
            animation: slideUp 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            transform-origin: bottom;
            animation: glow 2s infinite;
        }

        .popup-header {
            background: linear-gradient(135deg, #1a237e, #3949ab);
            color: white;
            padding: 32px 28px;
            text-align: center;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            border-radius: 24px 24px 0 0;
        }

        .company-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 14px;
            margin-bottom: 0;
            transition: transform 0.3s ease;
        }

        .company-logo:hover {
            transform: scale(1.02);
        }

        .popup-logo {
            width: 200px;
            max-width: 60%;
            height: auto;
            border-radius: 8px;
            object-fit: contain;
            background: transparent;
            padding: 0;
            filter: drop-shadow(0 4px 8px rgba(255,255,255,0.2));
            display: block;
            margin: 0 auto;
        }

        .popup-header .logo-text {
            font-size: 22px;
            font-weight: 700;
            color: white;
            margin: 0;
        }

        .popup-title {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .popup-subtitle {
            opacity: 0.9;
            font-size: 16px;
        }

        .popup-content {
            padding: 32px;
            background: linear-gradient(to bottom, #ffffff, #f8f9fa);
        }

        .popup-content h3 {
            color: #1a237e;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
            transition: color 0.3s ease;
        }

        .popup-content h3:hover {
            color: #3949ab;
        }

        /* New Result Stats Grid */
        .result-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .result-stat {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            text-align: center;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .result-stat:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.1);
        }

        .result-stat::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #1a237e, #3949ab);
        }

        .result-value {
            font-size: 36px;
            font-weight: 700;
            color: #1a237e;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .result-label {
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        /* Performance Rating */
        .performance-rating {
            text-align: center;
            margin: 25px 0;
            padding: 25px;
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            border-radius: 16px;
            border: 1px solid #e1f5fe;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            position: relative;
            overflow: hidden;
        }

        .performance-rating::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #1a237e, #3949ab);
        }

        .rating-text {
            font-size: 22px;
            font-weight: 600;
            color: #1a237e;
            margin-bottom: 12px;
        }

        .rating-stars {
            font-size: 32px;
            color: #FFD54F;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Popup Actions */
        .popup-actions {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 24px;
        }

        .popup-btn {
            flex: 1;
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .popup-btn.primary {
            background: linear-gradient(135deg, #1a237e, #3949ab);
            color: white;
        }

        .popup-btn.secondary {
            background: #f5f5f5;
            color: #333;
            border: 1px solid #e0e0e0;
        }

        .popup-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
        }

        .popup-btn.primary:hover {
            background: linear-gradient(135deg, #3949ab, #1a237e);
        }

        .popup-btn.secondary:hover {
            background: #e8e8e8;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(30px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Footer for Typing Test */
        .typing-footer {
            background: linear-gradient(135deg, #1a237e, #283593);
            color: white;
            padding: 40px 0 20px;
            margin-top: 50px;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 40px;
        }

        .footer-section {
            flex: 1;
            min-width: 250px;
        }

        .footer-section h3 {
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
            position: relative;
            padding-bottom: 10px;
        }

        .footer-section h3::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 40px;
            height: 2px;
            background: #4A90E2;
        }

        .footer-links {
            list-style: none;
        }

        .footer-links li {
            margin-bottom: 10px;
        }

        .footer-links a {
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .footer-links a:hover {
            color: #4A90E2;
            padding-left: 5px;
        }

        .footer-contact p {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: rgba(255,255,255,0.8);
        }

        .footer-bottom {
            text-align: center;
            padding-top: 20px;
            margin-top: 30px;
            border-top: 1px solid rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.7);
            font-size: 14px;
        }

        .social-links {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }

        .social-links a {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            color: white;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .social-links a:hover {
            background: #4A90E2;
            transform: translateY(-3px);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .text-display {
                font-size: 20px;
                padding: 25px;
                height: 120px;
            }
            
            .side-buttons {
                flex-direction: column;
                align-items: stretch;
            }
            
            .side-btn {
                width: 100%;
                justify-content: center;
            }
            
            .real-time-stats {
                flex-direction: column;
                gap: 15px;
            }
            
            .result-stats {
                grid-template-columns: 1fr;
            }
            
            .popup-actions {
                flex-direction: column;
            }
            
            nav ul {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            nav li {
                margin: 5px;
            }
            
            header {
                flex-direction: column;
                gap: 15px;
            }
            
            .footer-content {
                flex-direction: column;
                gap: 30px;
            }

            .popup-logo {
                width: 100px;
                height: auto;
            }

            .logo-text {
                font-size: 24px;
            }

            .popup-title {
                font-size: 24px;
            }

            .result-value {
                font-size: 28px;
            }

            .rating-text {
                font-size: 18px;
            }

            .rating-stars {
                font-size: 28px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-container">
                <img src="Public/Logo.png" alt="KJC Logo" class="logo">
                <div class="logo-text">Test ƒê√°nh M√°y KJC</div>
            </div>
            <nav>
                <ul>
                    <li><a href="index.html">Trang Ch·ªß</a></li>
                    <li><a href="typing.html" class="active">Ki·ªÉm Tra ƒê√°nh M√°y</a></li>
                    <li><a href="cv.html">T·∫°o CV Xin Vi·ªác</a></li>
                </ul>
            </nav>
        </header>

        <div class="typing-container">
            <h2>Ki·ªÉm Tra T·ªëc ƒê·ªô G√µ Ti·∫øng Vi·ªát</h2>
            <p>H√£y g√µ n·ªôi dung d∆∞·ªõi ƒë√¢y c√†ng nhanh, c√†ng ch√≠nh x√°c, c√†ng t·ªët ƒë·ªÉ ho√†n th√†nh h·ªì s∆° ·ª©ng tuy·ªÉn v√† Li√™n Minh Qu·ªëc T·∫ø KJC b·∫°n nh√©!</p>
            
            <!-- Real-time Stats -->
            <div class="real-time-stats">
                <div class="stat-item">
                    <div class="stat-value" id="live-wpm">0</div>
                    <div class="stat-label">WPM</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="live-accuracy">0%</div>
                    <div class="stat-label">ƒê·ªô ch√≠nh x√°c</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="live-correct">0</div>
                    <div class="stat-label">T·ª´ ƒë√∫ng</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="live-errors">0</div>
                    <div class="stat-label">T·ª´ sai</div>
                </div>
            </div>

            <!-- Time Progress Bar -->
            <div class="time-progress-container">
                <div class="time-progress-bar">
                    <div class="time-progress-fill" id="time-progress-fill"></div>
                </div>
                <div class="time-progress-text">
                    <span>Th·ªùi gian c√≤n l·∫°i:</span>
                    <span class="time-remaining" id="time-remaining">60 gi√¢y</span>
                </div>
            </div>
            
            <div class="typing-area">
                <div class="text-display" id="text-display">
                    <!-- Words will be inserted by JavaScript -->
                </div>
                
                    <div class="input-area">
                        <div class="input-row">
                            <input type="text" class="typing-input" id="typing-input" placeholder="B·∫Øt ƒë·∫ßu g√µ t·ª´ ƒë·∫ßu ti√™n...">
                            <button class="side-btn inline" id="retry-btn">
                                <span>üîÑ</span> Th·ª≠ L·∫°i
                            </button>
                        </div>
                    </div>
            </div>

            <!-- Side Buttons removed: retry moved next to input -->
        </div>
    </div>

    <!-- Enhanced Result Popup -->
    <div class="popup-overlay" id="result-popup">
        <div class="result-popup">
            <div class="popup-header">
                <div class="company-logo">
                    <img src="Public/Logo.png" alt="KJC Logo" class="popup-logo">
                </div>
                <h2 class="popup-title">K·∫øt Qu·∫£ Ki·ªÉm Tra</h2>
                <p class="popup-subtitle">Ph√¢n t√≠ch hi·ªáu su·∫•t g√µ c·ªßa b·∫°n</p>
            </div>
            <div class="popup-content">
                <h3>Th·ªëng K√™ Chi Ti·∫øt</h3>
                <div class="result-stats">
                    <div class="result-stat">
                        <div class="result-value" id="result-wpm">
                            <span>üìä</span> 0
                        </div>
                        <div class="result-label">T·ªëc ƒë·ªô g√µ (WPM)</div>
                    </div>
                    <div class="result-stat">
                        <div class="result-value" id="result-accuracy">
                            <span>üéØ</span> 0%
                        </div>
                        <div class="result-label">ƒê·ªô ch√≠nh x√°c</div>
                    </div>
                    <div class="result-stat">
                        <div class="result-value" id="result-correct">
                            <span>‚úÖ</span> 0
                        </div>
                        <div class="result-label">T·ª´ ƒë√∫ng</div>
                    </div>
                    <div class="result-stat">
                        <div class="result-value" id="result-errors">
                            <span>‚ùå</span> 0
                        </div>
                        <div class="result-label">T·ª´ sai</div>
                    </div>
                </div>

                <div class="performance-rating">
                    <div class="rating-text" id="rating-text">ƒêang ƒë√°nh gi√°...</div>
                    <div class="rating-stars" id="rating-stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
                </div>

                <div class="popup-actions">
                    <button class="popup-btn primary" id="popup-retry">
                        <span>üîÑ</span> Th·ª≠ L·∫°i Ngay
                    </button>
                    <button class="popup-btn secondary" id="popup-home">
                        <span>üè†</span> V·ªÅ Trang Ch·ªß
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer for Typing Test -->
    <footer class="typing-footer">
        <div class="footer-content">
            <div class="footer-section">
                <h3>V·ªÅ Test ƒê√°nh M√°y KJC</h3>
                <p>Cung c·∫•p c√°c c√¥ng c·ª• h·ªó tr·ª£ ·ª©ng tuy·ªÉn v√† l√†m vi·ªác t·∫°i Li√™n Minh Qu·ªëc T·∫ø KJC</p>
            </div>
            
            <div class="footer-section">
                <h3>C√¥ng C·ª•</h3>
                <ul class="footer-links">
                    <li><a href="index.html">Trang Ch·ªß</a></li>
                    <li><a href="typing.html">Ki·ªÉm tra t·ªëc ƒë·ªô g√µ</a></li>
                    <li><a href="cv.html">T·∫°o CV chuy√™n nghi·ªáp</a></li>
                </ul>
            </div>
            
            <div class="footer-section">
                <h3>H·ªó Tr·ª£</h3>
                <ul class="footer-links">
                    <li><a href="#">Trung t√¢m tr·ª£ gi√∫p</a></li>
                    <li><a href="#">H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</a></li>
                    <li><a href="#">C√¢u h·ªèi th∆∞·ªùng g·∫∑p</a></li>
                    <li><a href="#">Li√™n h·ªá h·ªó tr·ª£</a></li>
                </ul>
            </div>
            
            <div class="footer-section">
                <h3>Li√™n H·ªá</h3>
                <div class="footer-contact">
                    <p>Email: admin@kjc.com</p>
                    <p>SƒêT: 0815248322</p>
                    <p>ƒê·ªãa Ch·ªâ: 1M ƒê∆∞·ªùng S·ªë 12, T√¢n Thu·∫≠n T√¢y, Qu·∫≠n 7, Th√†nh ph·ªë H·ªì Ch√≠ Minh.</p>
                </div>
            </div>
        </div>
        
        <div class="footer-bottom">
            <p>¬© 2025 KJC Test ƒê√°nh M√°y. T·∫•t c·∫£ c√°c quy·ªÅn ƒë∆∞·ª£c b·∫£o l∆∞u.</p>
        </div>
    </footer>

    <script>
        // Vietnamese single words for typing test
        const vietnameseWords = [
"xin","ch√†o","c·∫£m","∆°n","t·ªët","nghi·ªáp","ƒë·∫°i","h·ªçc","c√¥ng","vi·ªác",
"chuy√™n","nghi·ªáp","k·ªπ","nƒÉng","kinh","nghi·ªám","ph√°t","tri·ªÉn","c√¥ng","ngh·ªá",
"th√†nh","c√¥ng","h·∫°nh","ph√∫c","h·ªçc","t·∫≠p","l√†m","vi·ªác","s·ª©c","kh·ªèe",
"gia","ƒë√¨nh","b·∫°n","b√®","ƒë·ªìng","nghi·ªáp","du","l·ªãch","kh√°m","ph√°",
"th·ªÉ","thao","gi·∫£i","tr√≠","√¢m","nh·∫°c","ngh·ªá","thu·∫≠t","th·ª±c","ph·∫©m",
"dinh","d∆∞·ª°ng","m√¥i","tr∆∞·ªùng","thi√™n","nhi√™n","vƒÉn","h√≥a","truy·ªÅn","th·ªëng",
"kinh","t·∫ø","t√†i","ch√≠nh","gi√°o","d·ª•c","ƒë√†o","t·∫°o","y","t·∫ø",
"giao","th√¥ng","v·∫≠n","t·∫£i","x√¢y","d·ª±ng","ki·∫øn","tr√∫c","n√¥ng","nghi·ªáp",
"s·∫£n","xu·∫•t","th∆∞∆°ng","m·∫°i","d·ªãch","v·ª•","kh√°ch","s·∫°n","ng√¢n","h√†ng",
"b·∫£o","hi·ªÉm","an","to√†n","ph√°p","lu·∫≠t","c√¥ng","l√Ω","an","ninh",
"tr·∫≠t","t·ª±","qu·ªëc","ph√≤ng","ƒë·ªëi","ngo·∫°i","h·ª£p","t√°c","khoa","h·ªçc",
"nghi√™n","c·ª©u","s√°ng","t·∫°o","th√¥ng","tin","li√™n","l·∫°c","ƒëi·ªán","tho·∫°i",
"m√°y","t√≠nh","·ª©ng","d·ª•ng","ti·ªán","√≠ch","trang","m·∫°ng","x√£","h·ªôi",
"th∆∞∆°ng","hi·ªáu","uy","t√≠n","kh√°ch","h√†ng","s·∫£n","ph·∫©m","ch·∫•t","l∆∞·ª£ng",
"c·∫°nh","tranh","th·ªã","tr∆∞·ªùng","chi·∫øn","l∆∞·ª£c","k·∫ø","ho·∫°ch","qu·∫£n","l√Ω",
"l√£nh","ƒë·∫°o","nh√¢n","vi√™n","l∆∞∆°ng","th∆∞·ªüng","ph√∫c","l·ª£i","ƒë√°nh","gi√°",
"hi·ªáu","su·∫•t","m·ª•c","ti√™u","k·∫øt","qu·∫£","th√°ch","th·ª©c","c∆°","h·ªôi",
"th·ªùi","gian","t∆∞∆°ng","lai","hi·ªán","t·∫°i","qu√°","kh·ª©","ni·ªÅm","tin",
"hy","v·ªçng","∆∞·ªõc","m∆°","cu·ªôc","s·ªëng","ng√†y","ƒë√™m","s√°ng","t·ªëi",
"tr·ªùi","ƒë·∫•t","n∆∞·ªõc","l·ª≠a","gi√≥","bi·ªÉn","n√∫i","r·ª´ng","hoa","l√°",
"c√¢y","c·ªè","m√πa","xu√¢n","h·∫°","thu","ƒë√¥ng","ch√¢n","tay","m·∫Øt",
"m≈©i","mi·ªáng","tai","ƒë·∫ßu","tim","√≥c","da","x∆∞∆°ng","m√°u","c∆°",
"th·ªãt","b·ª•ng","vai","l∆∞ng","ng·ª±c","c·ªï","b√†n","tay","ch√¢n","m√≥ng",
"ƒëi","ch·∫°y","nh·∫£y","ƒÉn","u·ªëng","ng·ªß","ngh·ªâ","c∆∞·ªùi","kh√≥c","h√°t",
"n√≥i","nghe","ƒë·ªçc","vi·∫øt","v·∫Ω","ch∆°i","xem","ƒëi·ªán","·∫£nh","phim",
"truy·ªán","tranh","b√°o","tin","th·ªùi","s·ª±","b·∫£n","tin","ch√≠nh","tr·ªã",
"x√£","h·ªôi","t·ª±","nhi√™n","v·∫≠t","l√Ω","h√≥a","sinh","to√°n","h·ªçc",
"ƒë·ªãa","l√Ω","l·ªãch","s·ª≠","vƒÉn","h·ªçc","ng·ªØ","ph√°p","ch√≠nh","t·∫£",
"t·ª´","v·ª±ng","t∆∞","duy","s√°ng","ki·∫øn","√Ω","t∆∞·ªüng","th·ª±c","h√†nh",
"l√Ω","thuy·∫øt","tr·∫£i","nghi·ªám","r√®n","luy·ªán","ki·∫øn","th·ª©c","h·ªçc","sinh",
"sinh","vi√™n","gi√°o","vi√™n","gi·∫£ng","vi√™n","th·∫ßy","c√¥","tr∆∞·ªùng","l·ªõp",
"b·∫£ng","b√∫t","v·ªü","s√°ch","b√†i","thi","ki·ªÉm","tra","k·ª≥","thi",
"ƒëi·ªÉm","s·ªë","b·∫±ng","c·∫•p","ch·ª©ng","ch·ªâ","h·ªçc","b·ªïng","th∆∞","vi·ªán",
"ph√≤ng","th√≠","nghi·ªám","m√°y","chi·∫øu","m√°y","in","gh·∫ø","b√†n","ƒë√®n",
"t·ªß","c·ª≠a","s·ªï","b·ª©c","t∆∞·ªùng","n·ªÅn","nh√†","s√†n","m√°i","tr·∫ßn",
"ƒë∆∞·ªùng","ph·ªë","xe","m√°y","√¥","t√¥","xe","ƒë·∫°p","xe","bu√Ωt",
"t√†u","bay","t√†u","h·ªèa","b·∫øn","xe","s√¢n","bay","c·∫£ng","bi·ªÉn",
"ng∆∞·ªùi","l·ªõn","tr·∫ª","em","thanh","ni√™n","ng∆∞·ªùi","gi√†","cha","m·∫π",
"anh","ch·ªã","em","v·ª£","ch·ªìng","con","ch√°u","√¥ng","b√†","b·∫°n",
"th√¢n","ng∆∞·ªùi","y√™u","ƒë·ªìng","nghi·ªáp","h√†ng","x√≥m","l√°ng","gi·ªÅng","th·∫ßy","tr√≤",
"th·∫ßy","thu·ªëc","b√°c","sƒ©","y","t√°","b·ªánh","nh√¢n","thu·ªëc","men",
"b·ªánh","vi·ªán","ph√≤ng","kh√°m","s·ª©c","kh·ªèe","ƒëi·ªÅu","d∆∞·ª°ng","ti√™m","ch·ªßng",
"vaccine","x√©t","nghi·ªám","m√°y","ƒëo","huy·∫øt","√°p","nhi·ªát","ƒë·ªô","m√°u",
"ch·∫©n","ƒëo√°n","ƒëi·ªÅu","tr·ªã","ph·∫´u","thu·∫≠t","d·ª•ng","c·ª•","y","khoa",
"c·∫•p","c·ª©u","xe","c·ª©u","th∆∞∆°ng","tai","n·∫°n","ph√≤ng","ch√°y","ch·ªØa",
"ch√°y","c·∫£nh","s√°t","c·ª©u","h·ªèa","b·ªô","ƒë·ªôi","bi√™n","ph√≤ng","h·∫£i",
"quan","h√†nh","ch√≠nh","c√¥ng","an","ch·ª©ng","minh","cƒÉn","c∆∞·ªõc","h·ªô",
"chi·∫øu","gi·∫•y","ph√©p","xe","b·∫±ng","l√°i","s·ªï","h·ªô","kh·∫©u","ƒëƒÉng",
"k√Ω","ƒëi·ªán","n∆∞·ªõc","thu·∫ø","thu","chi","doanh","thu","l·ª£i","nhu·∫≠n",
"kinh","doanh","b√°n","h√†ng","mua","h√†ng","qu·∫£ng","c√°o","truy·ªÅn","th√¥ng",
"chi·∫øn","d·ªãch","khuy·∫øn","m√£i","gi·∫£m","gi√°","∆∞u","ƒë√£i","ƒë∆°n","h√†ng",
"giao","h√†ng","thanh","to√°n","chuy·ªÉn","kho·∫£n","ti·ªÅn","m·∫∑t","v√≠","ƒëi·ªán",
"t·ª≠","h√≥a","ƒë∆°n","phi·∫øu","xu·∫•t","nh·∫≠p","kho","v·∫≠n","chuy·ªÉn","b·ªëc",
"x·∫øp","ƒë√≥ng","g√≥i","bao","b√¨","tem","nh√£n","m√£","s·ªë","m√£",
"v·∫°ch","th√¥ng","b√°o","tin","nh·∫Øn","cu·ªôc","g·ªçi","li√™n","h·ªá","k·∫øt",
"b·∫°n","giao","l∆∞u","h·ªçc","h·ªèi","chia","s·∫ª","trao","ƒë·ªïi","th·∫£o",
"lu·∫≠n","h·ªôi","th·∫£o","h·ªçp","h·ªôi","ngh·ªã","s·ª±","ki·ªán","l·ªÖ","k·ª∑",
"ni·ªám","l·ªÖ","khai","gi·∫£ng","l·ªÖ","t·ªët","nghi·ªáp","l·ªÖ","c∆∞·ªõi","sinh",
"nh·∫≠t","l·ªÖ","t·∫øt","nƒÉm","m·ªõi","trung","thu","gi√°ng","sinh","qu·ªëc",
"kh√°nh","qu·ªëc","t·∫ø","lao","ƒë·ªông","ph·ª•","n·ªØ","thi·∫øu","nhi","cha",
"m·∫π","gia","ƒë√¨nh","b·∫°n","b√®","thƒÉm","h·ªèi","ch√∫c","m·ª´ng","ch·ª•p",
"·∫£nh","quay","video","ghi","√¢m","th∆∞","t·ª´","email","tin","t·ª©c",
"b√°o","ch√≠","t·∫°p","ch√≠","truy·ªÅn","h√¨nh","ph√°t","thanh","loa","ƒë√†i",
"phim","·∫£nh","k·ªãch","s√¢n","kh·∫•u","v·∫Ω","tranh","ƒëi√™u","kh·∫Øc","ca",
"h√°t","nh·∫£y","m√∫a","ƒë√†n","ghita","piano","violin","nh·∫°c","c·ª•",
"b·∫£n","nh·∫°c","giai","ƒëi·ªáu","ti·∫øt","t·∫•u","√¢m","thanh","√°nh","s√°ng",
"m√†u","s·∫Øc","h√¨nh","·∫£nh","chuy·ªÉn","ƒë·ªông","t·ªëc","ƒë·ªô","th·ªùi","gian",
"gi√¢y","ph√∫t","gi·ªù","ng√†y","th√°ng","nƒÉm","m√πa","xu√¢n","h·∫°","thu",
"ƒë√¥ng","th·ªùi","ti·∫øt","m∆∞a","n·∫Øng","gi√≥","b√£o","s·∫•m","ch·ªõp","s∆∞∆°ng",
"m√π","nhi·ªát","ƒë·ªô","kh√≠","h·∫≠u","n∆∞·ªõc","bi·ªÉn","s√¥ng","su·ªëi","ao",
"h·ªì","ƒë·ªìng","ru·ªông","v∆∞·ªùn","hoa","c√¢y","c·ªè","tr√°i","ƒë·∫•t","n√∫i",
"ƒë·ªìi","hang","ƒë·ªông","r·ª´ng","bi·ªÉn","ƒë·∫£o","sa","m·∫°c","c√°t","ƒë√°",
"ƒë·∫•t","s√©t","b√πn","than","d·∫ßu","kh√≠","m·ªè","v√†ng","b·∫°c","kim",
"c∆∞∆°ng","ng·ªçc","ƒë√°","qu√Ω","s·∫Øt","th√©p","ƒë·ªìng","ch√¨","k·∫Ωm","g·ªó",
"gi·∫•y","nh·ª±a","v·∫£i","b√¥ng","len","l·ª•a","da","s·ª£i","s√†nh","g·ªëm",
"s·ª©","ƒë·ªì","ƒëi·ªán","m√°y","b∆°m","ƒë√®n","qu·∫°t","b·∫øp","n·ªìi","ch·∫£o",
"dao","th·ªõt","mu·ªóng","ƒë≈©a","ch√©n","b√°t","ƒëƒ©a","ly","c·ªëc","·∫•m",
"tr√†","c√†","ph√™","n∆∞·ªõc","√©p","s·ªØa","ƒë∆∞·ªùng","mu·ªëi","b·ªôt","m√¨",
"g·∫°o","th·ªãt","c√°","t√¥m","tr·ª©ng","rau","c·ªß","qu·∫£","canh","c∆°m",
"ch√°o","m√¨","ph·ªü","b√∫n","b√°nh","k·∫πo","s√∫p","n∆∞·ªõng","chi√™n","x√†o",
"lu·ªôc","h·∫•p","rang","n·∫•u","ƒÉn","u·ªëng","no","ƒë√≥i","ngon","mi·ªáng",
"th∆°m","ng·∫≠y","m·∫∑n","ng·ªçt","chua","cay","ƒë·∫Øng","nh·∫°t","·∫•m","n√≥ng",
"l·∫°nh","m√°t","∆∞·ªõt","kh√¥","s·∫°ch","b·∫©n","cao","th·∫•p","d√†i","ng·∫Øn",
"to","nh·ªè","ƒë·∫πp","x·∫•u","m·ªõi","c≈©","tr·∫ª","gi√†","ƒë√¥ng","√≠t",
"nhi·ªÅu","ƒë·∫ßy","v∆°i","ch·∫≠m","nhanh","s·ªõm","mu·ªôn","g·∫ßn","xa","tr√™n",
"d∆∞·ªõi","tr∆∞·ªõc","sau","trong","ngo√†i","tr√°i","ph·∫£i","gi·ªØa","b√™n","c·∫°nh",
"·ªü","ƒë√¢y","kia","ƒë√≥","n√†y","·∫•y","kia","ai","g√¨","n√†o",
"ƒë√¢u","khi","n√†o","bao","nhi√™u","v√¨","sao","th·∫ø","n√†o","ra",
"sao","ƒë√∫ng","sai","ph·∫£i","tr√°i","c√≥","kh√¥ng","ch∆∞a","ƒë√£","r·ªìi",
"v·∫´n","ƒëang","s·∫Ω","n√™n","c·∫ßn","mu·ªën","ph·∫£i","ƒë∆∞·ª£c","b·ªã","cho",
"l√†m","d·ª´ng","nghƒ©","bi·∫øt","hi·ªÉu","tin","nh·ªõ","qu√™n","th·∫•y","nghe",
"ng·ª≠i","n·∫øm","ch·∫°m","c·∫£m","nh·∫≠n","s·ª£","vui","bu·ªìn","t·ª©c","gi·∫≠n",
"h√†i","l√≤ng","lo","l·∫Øng","b√¨nh","tƒ©nh","t·ª±","tin","th√†nh","th·∫≠t",
"gi·∫£n","d·ªã","khi√™m","t·ªën","vui","v·∫ª","h√≤a","ƒë·ªìng","t·ªët","b·ª•ng",
"y√™u","th∆∞∆°ng","quan","t√¢m","chia","s·∫ª","gi√∫p","ƒë·ª°","bao","dung",
"tha","th·ª©","khoan","dung","c·∫£m","th√¥ng","t√¥n","tr·ªçng","ƒëo√†n","k·∫øt",
"trung","th·ª±c","c√¥ng","b·∫±ng","d≈©ng","c·∫£m","ki√™n","tr√¨","chƒÉm","ch·ªâ",
"nhi·ªát","huy·∫øt","c·∫ßn","c√π","th√¥ng","minh","s√°ng","su·ªët","t√†i","nƒÉng",
"ƒëi·ªÅm","ƒë·∫°m","k·ª∑","lu·∫≠t","ngƒÉn","n·∫Øp","tr·∫≠t","t·ª±","g·ªçn","g√†ng",
"ngƒÉn","ch·∫∑n","ph√≤ng","ng·ª´a","b·∫£o","v·ªá","gi·ªØ","g√¨n","x√¢y","d·ª±ng",
"ph√°t","tri·ªÉn","ƒë·ªïi","m·ªõi","c·∫£i","ti·∫øn","n√¢ng","cao","m·ªü","r·ªông",
"tƒÉng","tr∆∞·ªüng","hi·ªáu","qu·∫£","nƒÉng","su·∫•t","th√†nh","t√≠ch","th√†nh","t·ª±u",
"c·ªëng","hi·∫øn","ƒë√≥ng","g√≥p","h·ª£p","t√°c","h·ªôi","nh·∫≠p","ph√°t","tri·ªÉn",
"b·ªÅn","v·ªØng","to√†n","c·∫ßu","qu·ªëc","gia","ƒë·ªãa","ph∆∞∆°ng","th√†nh","ph·ªë",
"th·ªã","tr·∫•n","l√†ng","x√£","·∫•p","b·∫£n","th√¥n","nh√†","n∆∞·ªõc","ch√≠nh",
"ph·ªß","c∆°","quan","ban","ng√†nh","ƒë·∫£ng","ƒëo√†n","h·ªôi","ƒëo√†n","thanh",
"ni√™n","thi·∫øu","ni√™n","ph·ª•","n·ªØ","c·ª±u","chi·∫øn","binh","n√¥ng","d√¢n",
"c√¥ng","nh√¢n","vi√™n","ch·ª©c","doanh","nghi·ªáp","t·∫≠p","ƒëo√†n","c√¥ng","ty",
"vƒÉn","ph√≤ng","ph√≤ng","ban","ph√≤ng","kinh","doanh","ph√≤ng","nh√¢n","s·ª±",
"ph√≤ng","k·∫ø","to√°n","ph√≤ng","k·ªπ","thu·∫≠t","ph√≤ng","b·∫£o","v·ªá","ph√≤ng",
"nghi√™n","c·ª©u","ph√≤ng","thi·∫øt","k·∫ø","x∆∞·ªüng","s·∫£n","xu·∫•t","kho","v·∫≠n",
"chuy·ªÉn","giao","h√†ng","qu·∫£n","l√Ω","d·ª±","√°n","nh√¢n","s·ª±","t√†i","ch√≠nh",
"k·∫ø","to√°n","v·∫≠t","t∆∞","mua","h√†ng","b√°n","h√†ng","d·ªãch","v·ª•","h·ªó",
"tr·ª£","k·ªπ","thu·∫≠t","chƒÉm","s√≥c","kh√°ch","h√†ng","b·∫£o","h√†nh","b·∫£o","tr√¨"
        ];

        // DOM Elements
        const typingInput = document.getElementById('typing-input');
        const textDisplay = document.getElementById('text-display');
        const popupOverlay = document.getElementById('result-popup');
        
        // Real-time stats elements
        const liveWpmElement = document.getElementById('live-wpm');
        const liveAccuracyElement = document.getElementById('live-accuracy');
        const liveCorrectElement = document.getElementById('live-correct');
        const liveErrorsElement = document.getElementById('live-errors');
        
        // Time progress elements
        const timeProgressFill = document.getElementById('time-progress-fill');
        const timeRemainingElement = document.getElementById('time-remaining');
        
        // Result elements
        const resultWpmElement = document.getElementById('result-wpm');
        const resultAccuracyElement = document.getElementById('result-accuracy');
        const resultCorrectElement = document.getElementById('result-correct');
        const resultErrorsElement = document.getElementById('result-errors');
        const ratingText = document.getElementById('rating-text');
        const ratingStars = document.getElementById('rating-stars');

        // Variables
        let timer;
        let timeLeft = 60;
        let isTimerRunning = false;
        let startTime;
        let allWords = [];
        let visibleWords = [];
        let currentWordIndex = 0;
        let visibleStartIndex = 0;
        let correctChars = 0;
        let totalChars = 0;
        let correctWords = 0;
        let completedWords = 0;
        let typedWords = [];
        const WORDS_PER_LINE = 10; // TƒÉng s·ªë t·ª´ m·ªói d√≤ng
        const VISIBLE_LINES = 2; // S·ªë d√≤ng hi·ªÉn th·ªã

        // Initialize the test
        function initTest() {
            // Clear any existing timer
            if (timer) {
                clearInterval(timer);
                timer = null;
            }
            
            // Reset all variables to initial state first
            timeLeft = 60;
            typingInput.value = '';
            typingInput.disabled = false;
            isTimerRunning = false;
            currentWordIndex = 0;
            visibleStartIndex = 0;
            correctChars = 0;
            totalChars = 0;
            correctWords = 0;
            completedWords = 0;
            startTime = null;
            
            // Important: Clear typed words array completely
            typedWords = [];
            
            // Generate new words after resetting state
            generateRandomWords();
            updateVisibleWords();
            
            // Update UI with fresh state
            displayWords();
            updateLiveStats();
            updateTimeProgress();
            
            // Reset and hide popup (guard in case element missing)
            if (popupOverlay) popupOverlay.style.display = 'none';
            
            // Ensure input is enabled and focused
            typingInput.disabled = false;
            setTimeout(() => {
                typingInput.focus();
                // Double-check that we're showing a clean state
                displayWords();
            }, 50);
        }

        // Generate random words for the test
        function generateRandomWords() {
            allWords = [];
            const usedIndices = new Set();
            
            // Select 100 random single words
            while (allWords.length < 100) {
                const randomIndex = Math.floor(Math.random() * vietnameseWords.length);
                
                if (!usedIndices.has(randomIndex)) {
                    usedIndices.add(randomIndex);
                    allWords.push(vietnameseWords[randomIndex]);
                }
            }
        }

        // Update visible words (2 lines at a time)
        function updateVisibleWords() {
            const wordsPerPage = WORDS_PER_LINE * VISIBLE_LINES;
            visibleWords = allWords.slice(visibleStartIndex, visibleStartIndex + wordsPerPage);
        }

        // Display words with formatting and line breaks
        function displayWords() {
            let html = '';
            let wordCount = 0;
            
            for (let i = 0; i < visibleWords.length; i++) {
                const globalIndex = visibleStartIndex + i;
                let className = 'word';
                
                // Only add status classes if we have typed words and are not in initial state
                if (typedWords.length > 0 || isTimerRunning) {
                    if (globalIndex === currentWordIndex) {
                        className += ' current';
                    } else if (globalIndex < currentWordIndex) {
                        // Check if word was typed correctly
                        const isCorrect = typedWords[globalIndex] === allWords[globalIndex];
                        className += isCorrect ? ' correct' : ' incorrect';
                    }
                } else if (globalIndex === 0) {
                    // Just highlight first word when starting
                    className += ' current';
                }
                
                html += `<span class="${className}">${visibleWords[i]}</span>`;
                wordCount++;
                
                // Add line break after every WORDS_PER_LINE words
                if (wordCount % WORDS_PER_LINE === 0 && i < visibleWords.length - 1) {
                    html += '<div class="line-break"></div>';
                }
            }
            
            textDisplay.innerHTML = html;
        }

        // Load more words when needed
        function loadMoreWords() {
            const wordsPerPage = WORDS_PER_LINE * VISIBLE_LINES;
            const remainingWords = allWords.length - (visibleStartIndex + wordsPerPage);
            
            if (remainingWords > 0) {
                // Move to next page
                visibleStartIndex += wordsPerPage;
                updateVisibleWords();
                displayWords();
            }
        }

        // Update live statistics
        function updateLiveStats() {
            const currentTime = Date.now();
            const timeElapsed = (currentTime - startTime) / 1000 / 60; // in minutes
            
            // Calculate WPM using the formula: (correct chars including spaces √∑ 5) / time in minutes
            const wpm = timeElapsed > 0 ? Math.round((correctChars / 5) / timeElapsed) : 0;
            
            // Calculate accuracy
            const accuracy = totalChars > 0 ? Math.round((correctChars / totalChars) * 100) : 0;
            
            // Update display
            liveWpmElement.textContent = wpm;
            liveAccuracyElement.textContent = accuracy + '%';
            liveCorrectElement.textContent = correctWords;
            liveErrorsElement.textContent = completedWords - correctWords;
        }

        // Update time progress bar
        function updateTimeProgress() {
            const progressPercent = (timeLeft / 60) * 100;
            timeProgressFill.style.width = progressPercent + '%';
            timeRemainingElement.textContent = timeLeft + ' gi√¢y';
            
            // Change color based on remaining time
            if (timeLeft <= 15) {
                timeProgressFill.style.background = 'linear-gradient(90deg, #F44336, #FF9800)';
            } else if (timeLeft <= 30) {
                timeProgressFill.style.background = 'linear-gradient(90deg, #FF9800, #FFEB3B)';
            } else {
                timeProgressFill.style.background = 'linear-gradient(90deg, #4CAF50, #8BC34A)';
            }
        }

        // Start the timer
        function startTimer() {
            // Update progress bar immediately
            updateTimeProgress();

            // Use a safe interval that never allows timeLeft to go below 0
            timer = setInterval(function() {
                // If timeLeft is 1 or less, set to 0, update and finish
                if (timeLeft <= 1) {
                    timeLeft = 0;
                    updateTimeProgress();
                    clearInterval(timer);
                    finishTest();
                    return;
                }

                // Otherwise decrement normally
                timeLeft = Math.max(0, timeLeft - 1);
                updateTimeProgress();
            }, 1000);
        }

        // Calculate performance rating
        function calculateRating(wpm, accuracy) {
            let rating = 0;
            let text = '';
            let stars = '';
            
            if (wpm >= 60 && accuracy >= 95) {
                rating = 5;
                text = 'Xu·∫•t s·∫Øc! T·ªëc ƒë·ªô g√µ chuy√™n nghi·ªáp';
            } else if (wpm >= 45 && accuracy >= 90) {
                rating = 4;
                text = 'R·∫•t t·ªët! B·∫°n g√µ r·∫•t nhanh v√† ch√≠nh x√°c';
            } else if (wpm >= 30 && accuracy >= 85) {
                rating = 3;
                text = 'T·ªët! Ti·∫øp t·ª•c luy·ªán t·∫≠p ƒë·ªÉ c·∫£i thi·ªán';
            } else if (wpm >= 20 && accuracy >= 80) {
                rating = 2;
                text = 'Kh√°! C·∫ßn luy·ªán t·∫≠p th√™m ƒë·ªÉ tƒÉng t·ªëc ƒë·ªô';
            } else {
                rating = 1;
                text = 'C∆° b·∫£n! H√£y luy·ªán t·∫≠p th∆∞·ªùng xuy√™n h∆°n';
            }
            
            // Create stars based on rating
            stars = '‚òÖ'.repeat(rating) + '‚òÜ'.repeat(5 - rating);
            
            return { text, stars };
        }

        // Finish the test and show results
        function finishTest() {
            // Ensure interval is cleared and timer visually set to 0
            if (timer) {
                clearInterval(timer);
            }

            // Guarantee timeLeft is zero and update UI
            timeLeft = 0;
            updateTimeProgress();

            // Disable input and mark timer as not running
            typingInput.disabled = true;
            isTimerRunning = false;

            const endTime = Date.now();
            const timeTaken = (endTime - startTime) / 1000 / 60; // in minutes

            // Calculate WPM using the formula: (correct chars including spaces √∑ 5) / time in minutes
            const wpm = timeTaken > 0 ? Math.round((correctChars / 5) / timeTaken) : 0;

            // Calculate accuracy
            const accuracy = totalChars > 0 ? Math.round((correctChars / totalChars) * 100) : 0;

            // Calculate performance rating
            const rating = calculateRating(wpm, accuracy);

            // Display results in popup
            resultWpmElement.textContent = wpm;
            resultAccuracyElement.textContent = accuracy + '%';
            resultCorrectElement.textContent = correctWords;
            resultErrorsElement.textContent = completedWords - correctWords;
            ratingText.textContent = rating.text;
            ratingStars.textContent = rating.stars;

            // Show popup
            if (popupOverlay) popupOverlay.style.display = 'flex';
        }

        // Event Listeners
        typingInput.addEventListener('input', function() {
            if (!isTimerRunning) {
                startTimer();
                isTimerRunning = true;
                startTime = Date.now();
            }
            
            const typedText = this.value;
            const currentWord = allWords[currentWordIndex];
            
            // Check if space was pressed (word completed)
            if (typedText.endsWith(' ')) {
                const typedWord = typedText.trim();
                
                // Store the typed word
                typedWords[currentWordIndex] = typedWord;
                
                // Check if word is correct
                if (typedWord === currentWord) {
                    correctWords++;
                }
                
                // Update character statistics (include space)
                totalChars += currentWord.length + 1; // +1 for space
                if (typedWord === currentWord) {
                    correctChars += currentWord.length + 1; // +1 for space
                }
                
                // Move to next word
                currentWordIndex++;
                completedWords++;
                this.value = '';
                
                // Check if we need to load more words
                const wordsPerPage = WORDS_PER_LINE * VISIBLE_LINES;
                if (currentWordIndex >= visibleStartIndex + wordsPerPage) {
                    loadMoreWords();
                } else {
                    displayWords();
                }
                
                // Check if test is completed
                if (currentWordIndex >= allWords.length || timeLeft <= 0) {
                    finishTest();
                }
            }
            
            // Update stats
            updateLiveStats();
        });

        // Prevent going back to previous words by disabling backspace at word start
        typingInput.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace' && this.value === '') {
                e.preventDefault();
            }
            
            // Prevent arrow keys and other navigation
            if (e.key === 'ArrowLeft' || e.key === 'ArrowRight' || e.key === 'ArrowUp' || e.key === 'ArrowDown') {
                e.preventDefault();
            }
        });

        // Retry button handlers with debouncing to prevent double-clicks
        let isRetrying = false;
        
        function handleRetry() {
            if (isRetrying) return;
            isRetrying = true;
            
            initTest();
            
            // Reset retry flag after a delay
            setTimeout(() => {
                isRetrying = false;
            }, 500);
        }

        // Attach event listeners safely (check elements exist)
        const retryBtn = document.getElementById('retry-btn');
        const popupRetryBtn = document.getElementById('popup-retry');
        const popupHomeBtn = document.getElementById('popup-home');

        if (retryBtn) retryBtn.addEventListener('click', handleRetry);
        if (popupRetryBtn) popupRetryBtn.addEventListener('click', handleRetry);
        if (popupHomeBtn) popupHomeBtn.addEventListener('click', function() {
            window.location.href = 'index.html';
        });

        // Close popup when clicking outside (if overlay exists)
        if (popupOverlay) {
            popupOverlay.addEventListener('click', function(e) {
                if (e.target === popupOverlay) {
                    popupOverlay.style.display = 'none';
                }
            });
        }

        // Initialize the test when page loads
        window.addEventListener('load', initTest);
    </script>
</body>
</html>